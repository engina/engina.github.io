<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Expansion Module Architecture Design Experiences of ENDA Devices - Engin AYDOGAN's Journal</title>
        <meta name="viewport" content="width=device-width">
        <script src="//cdnjs.cloudflare.com/ajax/libs/prettify/r298/run_prettify.min.js" type="text/javascript"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.0/jquery.min.js" type="text/javascript"></script>
        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/css/syntax.css">

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/css/main.css">

    </head>
    <body>

        <div class="site">
          <div class="header">
            <h1 class="title"><a href="/">Engin AYDOGAN's Journal</a></h1>
            <a class="extra" href="/">home</a>
          </div>

          <h2>Expansion Module Architecture Design Experiences of ENDA Devices</h2>
<p class="meta">25 Nov 2010</p>

<div class="post">
<p style="text-align: left;"><strong>UPDATE</strong>: Please see <a title="Permanent Link: TX FIFO clear problem solved" rel="bookmark" href="http://engin.bzzzt.biz/2010/12/31/tx-fifo-clear-problem-solved/">TX FIFO clear problem solved</a></p>
<p style="text-align: left;">Implementing Expansion Modules support in PLC firmware was pretty easy, since from the eyes of the PLC (Main Device) all the Expansion Modules look like ONE device. It turned out that with LM3S8738 MCU, it is a challenging task to implement Expansion Module communication logic in the Expansion Modules. The reason is that LM3S8738 has RX and TX FIFOs for to be used in SSI but there's basically no control over the FIFOs. So I was not able to control the SSI peripheral as much as I wanted. Here's the problem and design principles of the expansion modules.</p>
<p style="text-align: center;"><img class="aligncenter" style="border: 0px initial initial;" src="/assets/6138.expansion.png_2D00_600x900.png" border="0" alt="" /></p>
<p style="text-align: center;">Basic logic</p>
<p style="text-align: left;">
<p>All devices are connected to a bus and driven by the SSI CLK generated by the  SSI Master which is the Main Device (MD from now on).  When a clock is generated each expansion device  (XD from now on) transmits data to the next XD -- except the last XD which transmits data back to MD and completes the loop. For instance in the first clock, MD sent 1 bit to XD A,  XD A sent 1 bit to XD B, XD B sent 1 bit to XD C and XD C sents 1 bit to MD. And all this transmission is enabled when the ENABLE line is LO. When the ENABLE line is HI all the XD's know that the transmission is over and the last N bytes they received are intended for themselves.</p>
<p>So imagine this hypothetical scenario. Each XD's message size is 1 byte and 3 XD's are connected to the MD. For MD to send query to these XDs, it should send 3 bytes. And MD will receive 3 bytes of answers for the previous query. So here's the work flow;</p>
<p>1. ENABLE line is LO</p>
<p>2. XDs put their answers for the previous query to TX FIFO. <span style="color: #ff0000;"><span style="font-size: xx-small;">(First I need to clear TX FIFO but I can't -- explained below)</span></span></p>
<p><img style="border: 0px initial initial;" src="/assets/8422.expansion_5F00_state1.png_2D00_600x0.png" border="0" alt="" /></p>
<p>3. MD sends 1 byte Query C to XD A.</p>
<p>4. XD A sends Response<sub>n-1</sub>A to XD B and puts Query C into its TX FIFO.</p>
<p>5. XD B sends Response<sub>n-1</sub>B to XD C and puts Response<sub>n-1</sub>A to its TX FIFO.</p>
<p>6. XD C sends Response<sub>n-1</sub>C  to MD and puts Response<sub>n-1</sub>B to its TX FIFO.</p>
<p>(Note that all steps from 3 to 7 happened simultaneously when MD is sending 1 byte, as required by the nature of SSI. )</p>
<p><img style="border: 0px initial initial;" src="/assets/5126.expansion_5F00_state2.png_2D00_600x0.png" border="0" alt="" /></p>
<p>7. MD sends 1 byte (Query B) to XD A.</p>
<p>8. XD A sends Query C to XD B and puts Query B to its TX FIFO.</p>
<p>9. XD B sends Responsen-1A to XD C and puts Query C to its TX FIFO.</p>
<p>10. XD C sends Responsen-1B to MD and puts Responsen-1A to TX FIFO.</p>
<p><img style="border: 0px initial initial;" src="/assets/2620.expansion_5F00_state3.png_2D00_600x0.png" border="0" alt="" /></p>
<p>11. MD sends 1 byte Query A to XD A</p>
<p>12. XD A sends Query B to XD B and puts Query A in its TX FIFO</p>
<p>13. XD B sends Query C to XD C and puts Query B to its TX FIFO.</p>
<p>14. XD C sends Responsen-1A to MD and puts Query C to its TX FIFO.</p>
<p><img style="border: 0px initial initial;" src="/assets/5657.expansion_5F00_state4.png_2D00_600x0.png" border="0" alt="" /></p>
<p>15. ENABLE line is HI.</p>
<p>16. Each XD looks for the last 1 byte they received and that's their query to process for the next round.</p>
<p><strong><span style="font-size: medium;">The Problem</span></strong></p>
<p>Since XDs don't know the total number of XDs connected to the bus they don't know how many bytes they will receive hence they rely on the ENABLE line. Whent he ENABLE line is HI, the last byte they got is their query. Since they don't know the total frame length (encapsulated by the ENABLE line) they don't know when not to put data to TX FIFO. <strong><span style="text-decoration: underline;">So there's a garbage byte in the TX FIFO when the transmission is over.</span></strong></p>
<p>Here're the things I could do.</p>
<p>1. Clear the TX FIFO each time ENABLE is LO, just before actual transmission begins -- there's no clean way to do this in LM3S8738 apparently.</p>
<p>2. Introduce another protocol element to tell XDs the size of the bus, so they'll know when not to put <strong>garbage data</strong> to TX FIFO.</p>
<p>3. Put XDs into SSI Master mode for a very short time to clean the TX FIFO. <em><span style="text-decoration: underline;">(I'm doing this right now, it works but it is not elegant).</span></em></p>
<p>4. Disable/Enable SSI peripheral to reset the TX FIFO. (I could not manage to do SysCtlPeripheralDisable, the CPU hangs, probably gets into a BUS FAULT).</p>
<p><span style="font-size: medium;"><strong>Conclusion</strong></span></p>
<p>In XDs we implemented with low level 8-bit MCUs, it has more granular control over the SSI peripheral -- which is simpler of course. There's no TX/RX FIFO, and you can just overwrite the outstanding data to be sent. So when ENABLED line is low, you just put your answer there and it overwrites the garbage, and you are done with it.</p>
<p>With LM3S8738 I'm still looking for more elegant ways to tackle this problem.</p>

</div>
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'enginsjournal'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    

          <div class="footer">
            <div class="contact">
              <p>
                Engin AYDOGAN<br />
                Thinker<br />
                e@ea.tl
              </p>
            </div>
            <div class="contact">
              <p>
                <a href="https://github.com/yourusername">github.com/engina</a><br />
                <a href="https://twitter.com/yourusername">twitter.com/jastsayn</a><br />
                <a class="extra" href="90s/">90s</a>
              </p>
            </div>
          </div>
        </div>
    </body>
    <script type="text/javascript">
    var k = [];
    $(document).ready(function(){
      $(document).keyup(function(e){
        k.push(e.keyCode);

        while(k.length > 3) {
          k.shift();
        }

        if(k.join() == '57,48,83') {
          document.location.href = '/90s/';
        }
      });
    });
    </script>
</html>
