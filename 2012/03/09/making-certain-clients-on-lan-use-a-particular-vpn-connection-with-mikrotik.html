<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Making certain clients on LAN use a particular VPN connection with Mikrotik - Engin AYDOGAN's Journal</title>
        <meta name="viewport" content="width=device-width">
        <script src="//cdnjs.cloudflare.com/ajax/libs/prettify/r298/run_prettify.min.js" type="text/javascript"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.0/jquery.min.js" type="text/javascript"></script>
        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/css/syntax.css">

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/css/main.css">

    </head>
    <body>

        <div class="site">
          <div class="header">
            <h1 class="title"><a href="/">Engin AYDOGAN's Journal</a></h1>
            <a class="extra" href="/">home</a>
          </div>

          <h2>Making certain clients on LAN use a particular VPN connection with Mikrotik</h2>
<p class="meta">09 Mar 2012</p>

<div class="post">
<p>Today, I received my RB-750GL from (<a href="http://www.kablosuzmarket.com">kablosuzmarket.com</a>) within 24h of my purchase, kudos for the excellent service. Rushed home to use this beast.</p>
<p>I had this idea for some time. To make certain devices on the LAN (i.e. Apple TV) to use a VPN connection so they appear to be from US (or whever the VPN server is). With Mikrotik it took just about half an hour to figure out how to do this.</p>
<p>1. Add your VPN connection into interface. In my case, I needed PPTP Client. Make sure it's connectedÂ successfully.</p>
<pre class="prettyprint">[admin@MikroTik] /interface&gt; print
Flags: D - dynamic, X - disabled, R - running, S - slave 
 #     NAME                                          TYPE             MTU   L2MTU
 0  R  ether1-gateway                                ether            1500  1598 
 1  R  ether2-local-master                           ether            1500  1598 
 2  R  ether3-local-slave                            ether            1500  1598 
 3     ether4-local-slave                            ether            1500  1598 
 4     ether5-local-slave                            ether            1500  1598 
 5  R  pppoe-out1                                    pppoe-out        1480 
 6  R  pptp-out1                                     pptp-out         1404</pre>
<p>Last one is my VPN connection.<br />
2. Prepare the address list of the devices you want to use this new VPN connection.</p>
<pre class="prettyprint">[admin@MikroTik] /ip firewall address-list&gt; print
Flags: X - disabled, D - dynamic 
 #   LIST                                         ADDRESS                        
 0   usvpn-addrlist                               192.168.1.104                  
 1   usvpn-addrlist                               192.168.1.254</pre>
<p>3. Add firewall rules to mark-route packets from this address list. I've marked them as "usvpn".</p>
<pre class="prettyprint">[admin@MikroTik] /ip firewall mangle&gt; print
Flags: X - disabled, I - invalid, D - dynamic 
 0   chain=prerouting action=mark-routing new-routing-mark=usvpn passthrough=yes src-address-list=usvpn-addrlist</pre>
<p>4. Now, route packets marked with "usvpn" route-mark via pptp1 interface.</p>
<pre class="prettyprint">[admin@MikroTik] &gt; ip route print 
Flags: X - disabled, A - active, D - dynamic, C - connect, S - static, r - rip, b - bgp, o - ospf, m - mme, 
B - blackhole, U - unreachable, P - prohibit 
 #      DST-ADDRESS        PREF-SRC        GATEWAY            DISTANCE
 0 A S  0.0.0.0/0                          pptp-out1          1       
 1 ADS  0.0.0.0/0                          78.171.192.1       1       
 2 ADC  10.10.0.1/32       10.10.0.2       pptp-out1          0       
 3 ADC  10.10.2.1/32       10.10.43.56     pppoe-out1         0       
 4 ADC  192.168.1.0/24     192.168.1.1     ether2-local-ma... 0</pre>
<p>The details are not visible in this print. When adding new route, just select the Gateway (pptp1) and Routing Mark (usvpn).</p>
<p>Now test if your devices are out in the US :)</p>

</div>
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'enginsjournal'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    

          <div class="footer">
            <div class="contact">
              <p>
                Engin AYDOGAN<br />
                Thinker<br />
                e@ea.tl
              </p>
            </div>
            <div class="contact">
              <p>
                <a href="https://github.com/yourusername">github.com/engina</a><br />
                <a href="https://twitter.com/yourusername">twitter.com/jastsayn</a><br />
              </p>
            </div>
          </div>
        </div>
    </body>
    <script type="text/javascript">
    var k = [];
    $(document).ready(function(){
      $(document).keyup(function(e){
        k.push(e.keyCode);

        while(k.length > 3) {
          k.shift();
        }

        if(k.join() == '57,48,83') {
          document.location.href = '/90s/';
        }
      });
    });
    </script>
</html>
