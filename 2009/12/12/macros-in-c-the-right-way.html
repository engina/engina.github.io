<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Macros in C/C++, the right way. - Engin AYDOGAN's Journal</title>
        <meta name="viewport" content="width=device-width">
        <script src="//cdnjs.cloudflare.com/ajax/libs/prettify/r298/run_prettify.min.js" type="text/javascript"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.0/jquery.min.js" type="text/javascript"></script>
        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/css/syntax.css">

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/css/main.css">

    </head>
    <body>

        <div class="site">
          <div class="header">
            <h1 class="title"><a href="/">Engin AYDOGAN's Journal</a></h1>
            <a class="extra" href="/">home</a>
          </div>

          <h2>Macros in C/C++, the right way.</h2>
<p class="meta">12 Dec 2009</p>

<div class="post">
<p>When used appropriately macros are very useful, yet they are very easy to misuse. Before getting into cons and pros, first lets make sure if we really know what is a macro and how does it work.</p>
<p>Roughly there are three stages of compilation in C; preprocessing, compiling, linking. It really makes sense and it is very easy to understand, don't think of this as a complex deal. We'll mostly talk about the preprocessor stage in this post. As the name implies, this stage just pre-processes the source code before compiling it, it all happens prior to compiling and that's it. Preprocessing includes defining some macros, and replacing each macro found in the source code with its value, so that it can be compiled. So get this right once and for all, macros are processed before compilation, they won't be in the run-time code.</p>
<p>As an exercise you can use -E parameter of GCC, which will make it stop right after the preprocessing stage.</p>
<p>Now, let's begin with a few examples;</p>
<pre class="prettyprint">#define ERROR_SEEK 152
if( errno == ERROR_SEEK )
{
    // Handle the error.
}</pre>
<p>This directive defines a macro ERROR_SEEK. Preprocessor will replace every occurrences of ERROR_SEEK with 152 prior to compiling. So, the code that is going to be sent to compiler will have "if( errno == 152)" not the ERROR_SEEK because the compiler simply does not know what ERROR_SEEK is. Nothing fancy, dead simple. But it makes the code much more readable. Look at this example;</p>
<pre class="prettyprint">#ifdef __GNUC__
#define COMPILER "gcc"
#else
#define COMPILER "proprietary"
#endif</pre>
<p>If __GNUC__ is defined somehow then every occurrences of COMPILER will be replaced with "gcc" and "proprietary" otherwise. Please note that this all happens before compilation, and this will not result in any executable code. In this special case __GNUC__ is defined by GCC itself. Though we can define a macro via #define directive in the source code, or with -D parameter of the compiler (which will work on most compilers).</p>
<p>Actually the name preprocessor says it all. All these preprocessor directives are pre processed before compilation. Makes sense uh ? Now I think we begin to understand the nature of macros/preprocessors.</p>
<p>Macros can be used to</p>
<ul>
<li>Improve readability (ERROR_SEEK is much more meaningful than 152)</li>
<li>Improve maintainability (When you change ERROR_SEEK in one header, it will be replaced all over the source code)</li>
<li>Ensuring that a block of code is inlined (more on this later)</li>
</ul>
<p>Though, if misused, the first two list items above will do  just the opposite :)</p>
<p>As for the possible disadvantages of preprocessors</p>
<ul>
<li>Could make debugging harder as lines of source lines before and after the preprocessing will be different, so debugger can be confused while stepping the executable code and matching which source line of code it is.</li>
<li>It is easy to misuse preprocessors.</li>
<li>Could cause trouble to static code analyzers.</li>
</ul>
<p>Now, possible misuse scenarios:</p>
<h2>1. Operator precedence</h2>
<p>The most common misuse scenario which you'll see in almost every C book is this;</p>
<pre class="prettyprint">#define FOO_CONST 83+22
printf("%d\n", FOO_CONST * 5 ); // This macro will expand to 83 + 22 *  5, hence will result 193.</pre>
<p>One could expect the result to be printed 525. But operator precedence would make the calculation 22 * 5 first, then add 83 to the result, so you'll see 193 as a result instead of 525. Fixing this problem is easy;</p>
<pre class="prettyprint">#define FOO_CONST (83+22)
printf("%d\n", FOO_CONST * 5 ); // This macro will expand to (83+22) * 5, hence will result 525.</pre>
<p>Enclosing the value of a macro is an easy way to ensure that they are evaluated in the right order.</p>
<h2>2. Multiple statements</h2>
<p>You can use multiple-statement macros to force inlining of a code block. Though note that this will increase the code size of your program. Anyway, the problem with the multiple-statements is a less known problem. Now, look at this.</p>
<pre class="prettyprint">#define HELLO(X) printf("Hello "); printf( X "\n" );</pre>
<p>The problem with this code is, if you want to conditionally run this code with "if" this code will not do what you intend to do.</p>
<pre class="prettyprint">if(0)
    HELLO("world"); // You'd expect that this HELLO() is never "executed".</pre>
<p>Above code will expand into</p>
<pre class="prettyprint">if(0)
    printf("Hello ");
printf( "world" "\n" );</pre>
<p>As you can see in the above example only the first statement in the macro is conditionally executed, this is not what we intended for. Above code will always print "world\n".</p>
<p>So, first thing comes to mind is to put them in curly brackets. Now let's evaluate that.</p>
<pre class="prettyprint">#define HELLO(X) { printf("Hello "); printf( X "\n" ); }</pre>
<p>Above code looks fine at first glance, but it will also introduce a sneaky bug that will result in compilation error. Now imagine above macro is used like this;</p>
<pre class="prettyprint">if(1)
    HELLO("world");
else
    HELLO("baby");</pre>
<p>This will expand into;</p>
<pre class="prettyprint">if(1)
{
    printf("Hello ");
    printf("world" "\n");
}; // WE GOT ERROR HERE
else
{
    printf("Hello ");
    printf("baby" "\n");
};</pre>
<p>So, here's the trick which works perfectly. It is the <em>do{} while(0)</em> trick. OK, let's see.</p>
<pre class="prettyprint">#define HELLO(X) do { printf("Hello "); printf( X "\n"); } while(0)</pre>
<p>You can use this as you please, imagine the <em>if else</em> scenario.</p>
<pre class="prettyprint">if(1)
    HELLO("world");
else
    HELLO("baby");</pre>
<p>This will expand into;</p>
<pre class="prettyprint">if(1)
    do { printf("Hello "); printf( "world" "\n" ); } while(0);
else
    do { printf("Hello "); printf( "baby" "\n" ); } while(0);</pre>
<p>So <em>do {} while(0)</em> does not break when you place a semi-colon after it and also has a scope. So it's a ideal for making sure your multiple-statements are executing as you expected.</p>
<p>Well, I guess that's all I've got to say.</p>

</div>
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'enginsjournal'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    

          <div class="footer">
            <div class="contact">
              <p>
                Engin AYDOGAN<br />
                Thinker<br />
                e@ea.tl
              </p>
            </div>
            <div class="contact">
              <p>
                <a href="https://github.com/yourusername">github.com/engina</a><br />
                <a href="https://twitter.com/yourusername">twitter.com/jastsayn</a><br />
              </p>
            </div>
          </div>
        </div>
    </body>
    <script type="text/javascript">
    var k = [];
    $(document).ready(function(){
      $(document).keyup(function(e){
        k.push(e.keyCode);

        while(k.length > 3) {
          k.shift();
        }

        if(k.join() == '57,48,83') {
          document.location.href = '/90s/';
        }
      });
    });
    </script>
</html>
